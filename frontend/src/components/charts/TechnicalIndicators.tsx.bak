import React, { useMemo } from 'react';
import { LineData } from 'lightweight-charts';

// Technical indicator calculation utilities
export class TechnicalIndicators {
  static sma(data: number[], period: number): number[] {
    const result: number[] = [];
    for (let i = period - 1; i < data.length; i++) {
      const sum = data.slice(i - period + 1, i + 1).reduce((a, b) => a + b, 0);
      result.push(sum / period);
    }
    return result;
  }

  static ema(data: number[], period: number): number[] {
    const result: number[] = [];
    const multiplier = 2 / (period + 1);
    
    // Start with SMA
    let ema = data.slice(0, period).reduce((a, b) => a + b, 0) / period;
    result.push(ema);
    
    // Calculate EMA for remaining data
    for (let i = period; i < data.length; i++) {
      ema = (data[i] - ema) * multiplier + ema;
      result.push(ema);
    }
    
    return result;
  }

  static rsi(data: number[], period: number = 14): number[] {
    const gains: number[] = [];
    const losses: number[] = [];
    
    // Calculate gains and losses
    for (let i = 1; i < data.length; i++) {
      const change = data[i] - data[i - 1];
      gains.push(change > 0 ? change : 0);
      losses.push(change < 0 ? Math.abs(change) : 0);
    }
    
    const result: number[] = [];
    
    // Calculate initial RS and RSI
    if (gains.length >= period) {
      let avgGain = gains.slice(0, period).reduce((a, b) => a + b, 0) / period;
      let avgLoss = losses.slice(0, period).reduce((a, b) => a + b, 0) / period;
      
      for (let i = period - 1; i < gains.length; i++) {
        if (i > period - 1) {
          avgGain = (avgGain * (period - 1) + gains[i]) / period;
          avgLoss = (avgLoss * (period - 1) + losses[i]) / period;
        }
        
        const rs = avgLoss === 0 ? 100 : avgGain / avgLoss;
        const rsi = 100 - (100 / (1 + rs));
        result.push(rsi);
      }
    }
    
    return result;
  }

  static macd(data: number[], fastPeriod: number = 12, slowPeriod: number = 26, signalPeriod: number = 9) {
    const fastEMA = this.ema(data, fastPeriod);
    const slowEMA = this.ema(data, slowPeriod);
    
    // MACD line
    const macdLine: number[] = [];
    const startIndex = slowPeriod - fastPeriod;
    
    for (let i = 0; i < fastEMA.length - startIndex; i++) {
      macdLine.push(fastEMA[i + startIndex] - slowEMA[i]);
    }
    
    // Signal line
    const signalLine = this.ema(macdLine, signalPeriod);
    
    // Histogram
    const histogram: number[] = [];
    const histStartIndex = signalPeriod - 1;
    
    for (let i = 0; i < macdLine.length - histStartIndex; i++) {
      histogram.push(macdLine[i + histStartIndex] - signalLine[i]);
    }
    
    return {
      macd: macdLine,
      signal: signalLine,
      histogram
    };
  }

  static bollinger(data: number[], period: number = 20, stdDev: number = 2) {
    const sma = this.sma(data, period);
    const upperBand: number[] = [];
    const lowerBand: number[] = [];
    
    for (let i = 0; i < sma.length; i++) {
      const dataSlice = data.slice(i, i + period);
      const mean = sma[i];
      const variance = dataSlice.reduce((sum, val) => sum + Math.pow(val - mean, 2), 0) / period;
      const standardDeviation = Math.sqrt(variance);
      
      upperBand.push(mean + (standardDeviation * stdDev));
      lowerBand.push(mean - (standardDeviation * stdDev));
    }
    
    return {
      middle: sma,
      upper: upperBand,
      lower: lowerBand
    };
  }
}

interface TechnicalIndicatorsPanelProps {
  data: { time: number; close: number }[];
  showSMA?: boolean;
  showEMA?: boolean;
  showRSI?: boolean;
  showMACD?: boolean;
  showBollinger?: boolean;
  smaLength?: number;
  emaLength?: number;
}

const TechnicalIndicatorsPanel: React.FC<TechnicalIndicatorsPanelProps> = ({
  data,
  showSMA = true,
  showEMA = false,
  showRSI = false,
  showMACD = false,
  showBollinger = false,
  smaLength = 20,
  emaLength = 12
}) => {
  const indicators = useMemo(() => {
    if (!data || data.length === 0) return {};

    const closes = data.map(d => d.close);
    const times = data.map(d => d.time);
    
    const result: any = {};

    if (showSMA && closes.length >= smaLength) {
      const smaValues = TechnicalIndicators.sma(closes, smaLength);
      result.sma = smaValues.map((value, index) => ({
        time: times[index + smaLength - 1],
        value
      }));
    }

    if (showEMA && closes.length >= emaLength) {
      const emaValues = TechnicalIndicators.ema(closes, emaLength);
      result.ema = emaValues.map((value, index) => ({
        time: times[index + emaLength - 1],
        value
      }));
    }

    if (showRSI && closes.length >= 15) {
      const rsiValues = TechnicalIndicators.rsi(closes);
      result.rsi = rsiValues.map((value, index) => ({
        time: times[index + 15],
        value
      }));
    }

    if (showMACD && closes.length >= 26) {
      const macdData = TechnicalIndicators.macd(closes);
      result.macd = macdData;
    }

    if (showBollinger && closes.length >= 20) {
      const bollingerData = TechnicalIndicators.bollinger(closes);
      result.bollinger = bollingerData;
    }

    return result;
  }, [data, showSMA, showEMA, showRSI, showMACD, showBollinger, smaLength, emaLength]);

  return (
    <div className="bg-gray-800 rounded-lg p-4 space-y-4">
      <h3 className="text-lg font-semibold text-white">Technical Indicators</h3>
      
      <div className="grid grid-cols-2 md:grid-cols-4 gap-4">
        {showSMA && indicators.sma && (
          <div className="bg-gray-700 rounded p-3">
            <div className="flex items-center space-x-2">
              <div className="w-3 h-3 bg-blue-500 rounded-full"></div>
              <span className="text-sm text-gray-300">SMA({smaLength})</span>
            </div>
            <div className="mt-1">
              <span className="text-lg font-bold text-white">
                ${indicators.sma[indicators.sma.length - 1]?.value.toFixed(2)}
              </span>
            </div>
          </div>
        )}

        {showEMA && indicators.ema && (
          <div className="bg-gray-700 rounded p-3">
            <div className="flex items-center space-x-2">
              <div className="w-3 h-3 bg-green-500 rounded-full"></div>
              <span className="text-sm text-gray-300">EMA({emaLength})</span>
            </div>
            <div className="mt-1">
              <span className="text-lg font-bold text-white">
                ${indicators.ema[indicators.ema.length - 1]?.value.toFixed(2)}
              </span>
            </div>
          </div>
        )}

        {showRSI && indicators.rsi && (
          <div className="bg-gray-700 rounded p-3">
            <div className="flex items-center space-x-2">
              <div className="w-3 h-3 bg-purple-500 rounded-full"></div>
              <span className="text-sm text-gray-300">RSI(14)</span>
            </div>
            <div className="mt-1">
              <span className="text-lg font-bold text-white">
                {indicators.rsi[indicators.rsi.length - 1]?.value.toFixed(2)}
              </span>
            </div>
          </div>
        )}

        {showMACD && indicators.macd && (
          <div className="bg-gray-700 rounded p-3">
            <div className="flex items-center space-x-2">
              <div className="w-3 h-3 bg-yellow-500 rounded-full"></div>
              <span className="text-sm text-gray-300">MACD</span>
            </div>
            <div className="mt-1">
              <span className="text-lg font-bold text-white">
                {indicators.macd.macd[indicators.macd.macd.length - 1]?.toFixed(4)}
              </span>
            </div>
          </div>
        )}
      </div>
    </div>
  );
};

export default TechnicalIndicatorsPanel;