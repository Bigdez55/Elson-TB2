---
# Vault Kubernetes Authentication Role
apiVersion: v1
kind: ConfigMap
metadata:
  name: vault-k8s-auth-config
data:
  setup.sh: |
    #!/bin/sh

    set -e

    # Enable Kubernetes auth method
    vault auth enable kubernetes

    # Configure Kubernetes auth method
    vault write auth/kubernetes/config \
      kubernetes_host="https://$KUBERNETES_SERVICE_HOST:$KUBERNETES_SERVICE_PORT" \
      token_reviewer_jwt="$(cat /var/run/secrets/kubernetes.io/serviceaccount/token)" \
      kubernetes_ca_cert="$(cat /var/run/secrets/kubernetes.io/serviceaccount/ca.crt)" \
      issuer="https://kubernetes.default.svc.cluster.local"

    # Create policy for backend access
    vault policy write backend - <<EOF
    # Database secrets
    path "kv/data/database" {
      capabilities = ["read"]
    }

    # API secrets
    path "kv/data/apis" {
      capabilities = ["read"]
    }

    # App secrets
    path "kv/data/app" {
      capabilities = ["read"]
    }
    EOF

    # Create policy for trading-engine access
    vault policy write trading-engine - <<EOF
    # Database secrets
    path "kv/data/database" {
      capabilities = ["read"]
    }

    # API secrets
    path "kv/data/apis" {
      capabilities = ["read"]
    }

    # App secrets
    path "kv/data/app" {
      capabilities = ["read"]
    }
    EOF

    # Create Kubernetes auth role for backend
    vault write auth/kubernetes/role/backend \
      bound_service_account_names=backend \
      bound_service_account_namespaces=default \
      policies=backend \
      ttl=24h

    # Create Kubernetes auth role for trading-engine
    vault write auth/kubernetes/role/trading-engine \
      bound_service_account_names=trading-engine \
      bound_service_account_namespaces=default \
      policies=trading-engine \
      ttl=24h

    # Enable KV secrets engine
    vault secrets enable -version=2 kv

    # Initial secrets
    echo "Setting up initial secrets..."
    
    vault kv put kv/database \
      url="postgresql://postgres:postgres@postgres-service:5432/elson" \
      user="postgres" \
      password="postgres"
    
    vault kv put kv/apis \
      alpha_vantage_key="placeholder_alpha_vantage_key" \
      finnhub_key="placeholder_finnhub_key" \
      fmp_key="placeholder_fmp_key" \
      polygon_key="placeholder_polygon_key" \
      coinbase_key="placeholder_coinbase_key" \
      stripe_key="placeholder_stripe_key" \
      stripe_webhook_secret="placeholder_stripe_webhook_secret" \
      schwab_key="placeholder_schwab_key" \
      schwab_secret="placeholder_schwab_secret"
    
    vault kv put kv/app \
      secret_key="placeholder_secret_key" \
      redis_url="redis://redis-service:6379/0"
    
    echo "Vault setup completed successfully!"

---
apiVersion: batch/v1
kind: Job
metadata:
  name: vault-setup
spec:
  backoffLimit: 4
  template:
    spec:
      serviceAccountName: vault
      restartPolicy: OnFailure
      containers:
      - name: vault-setup
        image: vault:1.13.3
        imagePullPolicy: IfNotPresent
        command:
        - /bin/sh
        - -c
        - |
          # Wait for Vault to be ready
          until vault status; do
            echo "Waiting for Vault to be ready..."
            sleep 5
          done
          
          # Initialize Vault if needed
          vault status > /dev/null || {
            echo "Initializing Vault..."
            vault operator init -key-shares=1 -key-threshold=1 > /tmp/vault-init
            
            # Unseal Vault
            UNSEAL_KEY=$(grep "Unseal Key 1" /tmp/vault-init | awk '{print $NF}')
            vault operator unseal $UNSEAL_KEY
            
            # Save root token (in production, this would be properly secured)
            ROOT_TOKEN=$(grep "Initial Root Token" /tmp/vault-init | awk '{print $NF}')
            echo "Root Token: $ROOT_TOKEN"
            export VAULT_TOKEN=$ROOT_TOKEN
            
            # Setup Kubernetes auth and secrets
            sh /vault/config/setup.sh
          }
        env:
        - name: VAULT_ADDR
          value: "http://vault:8200"
        volumeMounts:
        - name: vault-config
          mountPath: /vault/config
      volumes:
      - name: vault-config
        configMap:
          name: vault-k8s-auth-config
          defaultMode: 0755